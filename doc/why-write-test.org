# -*- coding: utf-8-unix -*-

# #+SETUPFILE: ./conf.org
# #+TITLE: なぜテストコードを書く必要があるのか

* なぜテストを書くのか

- テスト書くのめんどくね？
- 打鍵すりゃいいじゃん

** テスト効率がよい

- テスト準備がかんたん
- 結果確認がかんたん
- 実行が速い

※逆にこれらが満たされないとき、アンチパターンに陥っている可能性あり

*** テスト準備、入力がかんたん

- 仕組みを作れば、あとはデータを入れ替えるだけ
- 10画面遷移するカード新規入会画面

*** 結果確認がかんたん

- 値の比較はコンピュータの得意分野
- その目視確認、本当にちゃんとできていますか？

*** 実行が速い

- 大きなwar,jarのビルド不要
- デプロイ不要、再起動不要


** テストの粒度を細かくできる

xUnitを使ってユニットテストを書くと、テスト対象の粒度が細かくできます。

| テスト手法 | テスト対象       |
|------------+------------------|
| xUnit      | クラス, メソッド |
| 手動テスト | 画面, プログラム |

組み上がった巨大なシステムより、部品のほうがテストが楽


*** パチンコ部品検査のバイト

- 玉が通過したことを感知するセンサー
- 先端に玉がついた棒を、センサーに通して確認

この部品を、パチンコ台に組み込んでからテストするとしたら…？

#+ATTR_HTML: :width 300px
#+ATTR_ORG:  :width 300
[[./img/sensor.jpg]]

** 設計品質向上につながる

- 良い設計であれば、テストがしやすい。
- テストが書きにくいと感じたら、設計に問題あるかも

*** 『レガシーコード改善ガイド 』

#+BEGIN_QUOTE
良い設計はテスト可能であり、テスト可能でない設計は悪い設計である、ということは常に真実です。
#+END_QUOTE

*** 平鍋 健児さん

#+BEGIN_QUOTE
EoT(Ease of Testing)の高い設計が、よいオブジェクト指向設計である。
#+END_QUOTE

http://blogs.itmedia.co.jp/hiranabe/2005/08/post_e66c.html


** 資産になる

- 回帰テスト
- システムの仕様(振る舞い)を表す
  - プロダクションコードと一緒にバージョン管理される


** 新しい技術・手法を取り入れる

テストコードが無いと新しい技術を取り入れられない。

- リファクタリング
- アジャイル
- 継続的インテグレーション, 継続的デリバリー, DevOps
- ドメイン駆動設計(Domain Driven Design)
- マイクロサービスアーキテクチャ
- テスト駆動開発(Test Driven Development)

*** テストに関連する技術・手法の依存関係
#+BEGIN_SRC plantuml :file img/techs.png :cmdline -charset UTF-8
scale 400 * 500
object Test
object Refactoring
object "CI/CD" as cicd
object DevOps
object "Microservices" as msa
object Agile
object "Domain Driven Design" as ddd
' object "Test Driven Design" as tdd

Test -- Refactoring
' Test -- Agile
Refactoring -- Agile
Agile -- ddd
' Test -- tdd
' Refactoring -- tdd
Test -- cicd
cicd -- DevOps
DevOps -- msa
DevOps -- Agile

#+END_SRC

#+RESULTS:
[[file:img/techs.png]]


** 逆に、テストを書かないと…


*** 内部のアーキテクチャ検討が適当になる

- どのクラスをどうテストするか検討していない
  - ステレオタイプの定義をしない
- エントリポイントにだらだら処理を書く
  - 巨大なexecuteメソッド

*** システム外部からテストするしかなくなる

ブラウザやコマンドラインからしかテストができません。

- モジュール単体（クラス、メソッド）の品質を上げる機会を失う
- さらに内部の構造が適当になる

*** 構造を修正できない
- テストコード無しでリファクタリングは非現実的

https://images-na.ssl-images-amazon.com/images/I/51RWpUlhNxL._SX385_BO1,204,203,200_.jpg

*** 開発のツケが保守フェーズの負担となる

- スパゲッティのため修正（コード理解）に工数がかかる
- 回帰テストがないのでテスト工数がかさむ
- 素早く開発→デプロイを繰り返すこともできない
- 自分たちのやり方に自信が持てず、保守メンバーのモチベーション低下にも
